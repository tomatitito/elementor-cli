name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Start test environment
        run: |
          cd tests/e2e
          docker compose up -d

          # Wait for WordPress to be ready
          echo "Waiting for WordPress..."
          timeout 120 bash -c 'until curl -s http://localhost:8888 > /dev/null 2>&1; do sleep 2; done'

          # Stream CLI container logs in background to help debug seed script
          echo "Starting CLI log stream..."
          docker compose logs -f cli &
          LOG_PID=$!

          # Wait for seed script to complete
          echo "Waiting for seed script..."
          timeout 180 bash -c 'until docker exec elementor-cli-test-wp test -f /var/www/html/wp-content/test-pages.json 2>/dev/null; do sleep 5; done'

          # Stop log streaming
          kill $LOG_PID 2>/dev/null || true

          echo "Test environment ready!"

      - name: Show container status
        run: docker compose -f tests/e2e/docker-compose.yml ps

      - name: Show test credentials
        run: |
          echo "Test pages:"
          docker exec elementor-cli-test-wp cat /var/www/html/wp-content/test-pages.json
          echo ""
          echo "Credentials created successfully"

      - name: Run E2E tests
        run: bun test:e2e
        env:
          E2E_TEST_URL: http://localhost:8888

      - name: Show container logs on failure
        if: failure()
        run: |
          echo "=== WordPress logs ==="
          docker compose -f tests/e2e/docker-compose.yml logs wordpress
          echo ""
          echo "=== CLI logs ==="
          docker compose -f tests/e2e/docker-compose.yml logs cli

      - name: Cleanup
        if: always()
        run: docker compose -f tests/e2e/docker-compose.yml down -v
